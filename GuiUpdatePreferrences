<style type="text/css">

	.guiPreferencesHeader {
		margin: 20px;
		font: 200 24px/30px arial;
		color: #40922f;
	}

	.guiPreferencesPageWrapper {
		padding-top: 20px;
		padding-right: 20px;
		padding-bottom: 50px;
		padding-left: 20px;
	}

	.guiPreferencesTable {
		margin: 20px;
		width: 70%;
		border: 0px;
	}

		.guiPreferencesTable thead {
			border: 1px solid #cbcbcb;
		}

		.guiPreferencesTable thead tr th,
		.guiPreferencesTable tbody tr td {
			border-left: 0px;
			font: 200 14px/30px arial;
		}
   
	.guiPreferencesTable thead tr th {
		color: #40922f;
	}

	.guiPreferencesInput,
	.guiPreferencesInputError {
		width: 100%;
		height: 18px;
		border: 1px solid #ccc;
		border-top-left-radius: 4px;
		border-bottom-left-radius: 4px;
		padding: 5px 10px;
		font: 200 14px/30px arial;
	}

	.guiPreferencesInput {
		border: 1px solid #ccc;
	}

	.guiPreferencesInputError {
		border: 1px solid red;
	}

	.guiPreferencesButtonSaveWrapper {
		display: inline-block;
		border-top-right-radius: 4px;
		border-bottom-right-radius: 4px;
		left: 14px;
		position: relative;
	}

		.guiPreferencesButtonSaveWrapper button {
			border-top-left-radius: 0px;
			border-top-right-radius: 4px;
			border-bottom-right-radius: 4px;
			border-bottom-left-radius: 0px;
		}

	.guiPreferencesButtonReturnWrapper {
		width: 70%;
	}

	.guiPreferencesButtonReturn {
		float: right;
	}

	.guiPreferencesErrorMessage,
	.guiPreferencesSuccessMessage {
		height: 10px;
		padding: 0px;
		position: relative;
		top: -20px;
		display: none;
	}

	.guiPreferencesErrorMessage {
		color: red;
	}

	.guiPreferencesSuccessMessage {
		color: #40922f;
	}	

</style>

<div class="guiPreferencesPageWrapper">

	<div class="guiPreferencesHeader">設定載具條碼及捐贈碼</div>
	<table class="pure-table guiPreferencesTable">
		<thead>
			<tr>
				<th>類別</th>
				<th>號碼</th>
			</tr>
		</thead>

		<tbody>
			<tr>
				<td>手機載具條碼</td>
				<td>
					<div class="pure-g">
						<div class="pure-u-24-24">
							<div class="pure-u-19-24">
								<input class="ui-autocomplete-input guiPreferencesInput" id="txtGuiCarrierCode" type="text" value="">
							</div>
							<div class="pure-u-4-24 guiPreferencesButtonSaveWrapper">
								<button class="pure-button pure-button-10 green pure-button-transparent" id="btnUpdateGuiCarrierCode" onclick="saveCarrierCode();" type="button">
									<font style="vertical-align: inherit;">
										<font style="vertical-align: inherit;">儲存</font>
									</font>
								</button>
							</div>
						</div>
					</div>
				</td>
			</tr>
			<tr>
				<td></td>
				<td>
					<div id="errorValidationCarrierCode" class="guiPreferencesErrorMessage">請輸入手機載具條碼</div>
					<div id="errorGeneralCarrierCode" class="guiPreferencesErrorMessage">無法儲存</div>
					<div id="successCarrierCode" class="guiPreferencesSuccessMessage">儲存成功</div>
				</td>
			</tr>

			<tr>
				<td>自然人憑證條碼</td>
				<td>
					<div class="pure-g">
						<div class="pure-u-24-24">
							<div class="pure-u-19-24">
								<input class="ui-autocomplete-input guiPreferencesInput" id="txtGuiGovernmentIdCode" type="text" value="">
							</div>
							<div class="buttonWrapper pure-u-4-24 guiPreferencesButtonSaveWrapper" style="display: inline-block;">
								<button class="pure-button pure-button-10 green pure-button-transparent" id="btnUpdateGuiGovernmentIdCode" onclick="saveGovernmentIdCode();" type="button">
									<font style="vertical-align: inherit;">
										<font style="vertical-align: inherit;">儲存</font>
									</font>
								</button>
							</div>
						</div>
					</div>
				</td>
			</tr>
			<tr>
				<td></td>
				<td>
					<div id="errorValidationGovernmentId" class="guiPreferencesErrorMessage">請輸入自然人憑證條碼</div>
					<div id="errorGeneralGovernmentId" class="guiPreferencesErrorMessage">無法儲存</div>
					<div id="successGovernmentId" class="guiPreferencesSuccessMessage">儲存成功</div>
				</td>
			</tr>

			<tr>
				<td>捐贈碼</td>
				<td>
					<div class="pure-g">
						<div class="pure-u-24-24">
							<div class="pure-u-19-24">
								<input list="ctrlGuiDonationCodeSearch" class="guiPreferencesInput" name="ctrlGuiDonationCodeSearch">
								<datalist id="ctrlGuiDonationCodeSearch" class="guiPreferencesInput"> </datalist>
							</div>
							<div class="buttonWrapper pure-u-4-24 guiPreferencesButtonSaveWrapper" style="display: inline-block;">
								<button class="pure-button pure-button-10 green pure-button-transparent" id="btnUpdateGuiDonationCode" onclick="saveDonationCode();" type="button">
									<font style="vertical-align: inherit;">
										<font style="vertical-align: inherit;">儲存</font>
									</font>
								</button>
							</div>
						</div>
					</div>
				</td>
			</tr>
			<tr>
				<td></td>
				<td>
					<div id="errorValidationDonationCode" class="guiPreferencesErrorMessage">請輸入捐贈碼</div>
					<div id="errorGeneralDonationCode" class="guiPreferencesErrorMessage">無法儲存</div>
					<div id="successDonationCode" class="guiPreferencesSuccessMessage">儲存成功</div>
				</td>
			</tr>

		</tbody>
	</table>
	<div class="guiPreferencesButtonReturnWrapper">
		<button class="pure-button pure-button-10 pure-button-green guiPreferencesButtonReturn" id="btnRedirectFormerPage" onclick="redirectToPage()" type="button">
			<font style="vertical-align: inherit;">
				<font style="vertical-align: inherit;">返回結帳</font>
			</font>
		</button>
	</div>
</div>


<script type="text/javascript">

	var $donationCodeJson;
	var $donationCodeSearchInput = $("[name=ctrlGuiDonationCodeSearch]");
	var $donationCodeSearchDdl = $("#ctrlGuiDonationCodeSearch");
	var $carrierCodeInput = $("#txtGuiCarrierCode");
	var $governmentIdCodeInput = $("#txtGuiGovernmentIdCode");

	var $CarrierCodeBtn = $("#btnUpdateGuiCarrierCode");
	var $GovernmentIdCodeBtn = $("#btnUpdateGuiGovernmentIdCode");
	var $DonationCodeBtn = $("#btnUpdateGuiDonationCode");

	var $CarrierCodeHdn = $("#hdnPhoneCode");
	var $GovernmentIdCodeHdn = $("#hdnCitizenIdentificationCode");
	var $DonationCodeHdn = $("#hdnDonationCode");
	var $CarrierRegexHdn = $("#hdnCarrierRegex");
	var $GovernmentIdRegexHdn = $("#hdnGovernmentIdRegex");
	var $DonationCodeListHdn = $("#hdnDonationCodeListJson");

	var $ErrorValidationCarrierCode = $("#errorValidationCarrierCode");
	var $ErrorValidationGovernmentId = $("#errorValidationGovernmentId");
	var $ErrorValidationDonationCode = $("#errorValidationDonationCode");
	var $ErrorGeneralCarrierCode = $("#errorGeneralCarrierCode");
	var $ErrorGeneralGovernmentId = $("#errorGeneralGovernmentId");
	var $ErrorGeneralDonationCode = $("#errorGeneralDonationCode");
	var $SuccessCarrierCode = $("#successCarrierCode");
	var $SuccessGovernmentId = $("#successGovernmentId");
	var $SuccessDonationCode = $("#successDonationCode");


	$(document).ready(function () {

		$ErrorValidationCarrierCode.hide();
		$ErrorValidationGovernmentId.hide();
		$ErrorValidationDonationCode.hide();
		$ErrorGeneralCarrierCode.hide();
		$ErrorGeneralGovernmentId.hide();
		$ErrorGeneralDonationCode.hide();
		$SuccessCarrierCode.hide();
		$SuccessGovernmentId.hide();
		$SuccessDonationCode.hide();

		$donationCodeSearchInput.val($DonationCodeHdn.val());
		$carrierCodeInput.val($CarrierCodeHdn.val());
		$governmentIdCodeInput.val($GovernmentIdCodeHdn.val());


		$donationCodeSearchInput.on('input', function () {
			if ($donationCodeSearchInput.val() != $DonationCodeHdn.val()) {
				searchDonationCode();
			}                
		});

		$carrierCodeInput.on('input', function () {
			resetNonValidationMessages(1);
			resetSuccessMessages(1);
			if ($CarrierCodeHdn.val() != $carrierCodeInput.val()
				&& $carrierCodeInput.val().match(new RegExp($CarrierRegexHdn.val(), "i"))) {
				resetValidationMessages(1);
			}
		});

		$governmentIdCodeInput.on('input', function () {
			resetNonValidationMessages(2);
			resetSuccessMessages(2);
			if ($GovernmentIdCodeHdn.val() != $governmentIdCodeInput.val()
				&& $governmentIdCodeInput.val().match($GovernmentIdRegexHdn.val())) {                    
				resetValidationMessages(2);
			}
		});

	});

	function saveCarrierCode() {
		if($carrierCodeInput.val() === ''){
		    return;    
		}
		
		if ($CarrierCodeHdn.val() != $carrierCodeInput.val()) {
			SaveGovernmentUniformInvoiceCode($carrierCodeInput.val(), 1);
		}
		else {
			showSuccessMessage(1);
		}
	}

	function saveGovernmentIdCode() {
		if($governmentIdCodeInput.val() === ''){
		    return;    
		}
		
		if ($GovernmentIdCodeHdn.val() != $governmentIdCodeInput.val()) {
			SaveGovernmentUniformInvoiceCode($governmentIdCodeInput.val(), 2);
		}
		else {
			showSuccessMessage(2);
		}
	}

	function saveDonationCode() {
		if($donationCodeSearchInput.val() === ''){
		    return;    
		}
		
		if ($DonationCodeHdn.val() != $donationCodeSearchInput.val()) {
			SaveDonationCode($donationCodeSearchInput.val());
		}
		else {
			showSuccessMessage(0);
		}
	}

	function searchDonationCode() {
		resetNonValidationMessages(0);
		resetSuccessMessages(0);
		if ($donationCodeSearchInput.val().length >= 3) {
			if (typeof $donationCodeJson == 'undefined') {
				var donationCodeListJson = jQuery.parseJSON($DonationCodeListHdn.val());

                    $donationCodeJson = $.map(donationCodeListJson, function (value, key) {
                
                        return {
                            LoveCode: key,
                            SocialWelfareName: value
                        }
                    });
			}

			var regEx = new RegExp($donationCodeSearchInput.val(), "i");
			var count = 0;
			var donationCodeId;
			var options;
			$donationCodeSearchDdl.empty();

			$.each($donationCodeJson, function (i, v) {

				if (count < 50 && v.SocialWelfareName.search(regEx) != -1) {
					donationCodeId = v.LoveCode;
					if (count == 0) {
						options = "<option value='" + v.LoveCode + "'>" + v.SocialWelfareName + "</option>";
					}
					else if (count > 0) {
						options = options + "<option value='" + v.LoveCode + "'>" + v.SocialWelfareName + "</option>";
					} 
					count++;
					return;
				}
				else if (count < 50 && v.LoveCode.search(regEx) != -1) {
					donationCodeId = v.LoveCode;
					if (count == 0) {
						options = "<option value='" + v.LoveCode + "'>" + v.SocialWelfareName + "</option>";
					}
					else if (count > 0) {
						options = options + "<option value='" + v.LoveCode + "'>" + v.SocialWelfareName + "</option>";
					}
					count++;
					return;
				}

			});

			if (count == 1 && donationCodeId == $donationCodeSearchInput.val()) {
				resetValidationMessages(0);
			}
			else if (count >= 1) {
				$donationCodeSearchDdl.append(options);
			}
		}
	}

	function SaveGovernmentUniformInvoiceCode(codeValue, codeType) {
		$.ajax({
			type: "POST",
			url: "/MyAccount/AccountPreferences/SaveGovernmentUniformInvoiceCode",
			cache: false,
			data: { guiCarrierType: codeType, guiValue: codeValue }
		}).done(function (response) {
			if (response.Success) {
				showSuccessMessage(codeType);
			}
			if (!response.Success) {
				if (response.ErrorMessage == "Validation") {
					showValidationMessage(codeType);
				}
				else {
					showGeneralErrorMessage(codeType);
				}                                        
			}
		}).fail(function () {
			showGeneralErrorMessage(codeType);
		});
	}

	function SaveDonationCode(codeValue) {
		$.ajax({
			type: "POST",
			url: "/MyAccount/AccountPreferences/SaveGovernmentUniformInvoiceDonationCode",
			cache: false,
			data: { guiValue: codeValue }
		}).done(function (response) {
			if (response.Success) {
				showSuccessMessage(0);
			}
			if (!response.Success) {
				if (response.ErrorMessage == "Validation") {
					showValidationMessage(0);
				}
				else {
					showGeneralErrorMessage(0);
				}
			}
		}).fail(function () {
			showGeneralErrorMessage(0);
		});
	}

	function redirectToPage() {
	    var referralUrl = $redirectPathHdn.val();
	    
	    if(referralUrl === '~/Account'){
	        window.location.href = '/account';    
	    }
	    else{
	        window.location.href = '/ProductStore/Checkout';    
	    }
		
	}

	function showSuccessMessage(codeType) {

		resetNonValidationMessages(codeType);
		resetValidationMessages(codeType);

		switch (codeType) {
			case 1:
				$SuccessCarrierCode.show();
				break;
			case 2:
				$SuccessGovernmentId.show();
				break;
			case 0:
				$SuccessDonationCode.show();
				break;
			default:
				break;
		} 
	}

	function showValidationMessage(codeType) {

		resetNonValidationMessages(codeType);
		resetSuccessMessages(codeType);

		switch (codeType) {
			case 1:
				$ErrorValidationCarrierCode.show();
				if (!$carrierCodeInput.hasClass('guiPreferencesInputError')) {
					$carrierCodeInput.addClass('guiPreferencesInputError')
				}
				if ($carrierCodeInput.hasClass('guiPreferencesInput')) {
					$carrierCodeInput.removeClass('guiPreferencesInput')
				}
				break;
			case 2:
				$ErrorValidationGovernmentId.show();
				if (!$governmentIdCodeInput.hasClass('guiPreferencesInputError')) {
					$governmentIdCodeInput.addClass('guiPreferencesInputError')
				}
				if ($governmentIdCodeInput.hasClass('guiPreferencesInput')) {
					$governmentIdCodeInput.removeClass('guiPreferencesInput')
				}                    
				break;
			case 0:
				$ErrorValidationDonationCode.show();
				if (!$donationCodeSearchInput.hasClass('guiPreferencesInputError')) {
					$donationCodeSearchInput.addClass('guiPreferencesInputError')
				}
				if ($donationCodeSearchInput.hasClass('guiPreferencesInput')) {
					$donationCodeSearchInput.removeClass('guiPreferencesInput')
				}
				break;
			default:
				break;
		} 
	}

	function showGeneralErrorMessage(codeType) {

		resetValidationMessages(codeType);
		resetSuccessMessages(codeType);

		switch (codeType) {
			case 1:
				$ErrorGeneralCarrierCode.show();
				if (!$carrierCodeInput.hasClass('guiPreferencesInputError')) {
					$carrierCodeInput.addClass('guiPreferencesInputError')
				}
				if ($carrierCodeInput.hasClass('guiPreferencesInput')) {
					$carrierCodeInput.removeClass('guiPreferencesInput')
				}
				break;
			case 2:
				$ErrorGeneralGovernmentId.show();
				if (!$governmentIdCodeInput.hasClass('guiPreferencesInputError')) {
					$governmentIdCodeInput.addClass('guiPreferencesInputError')
				}
				if ($governmentIdCodeInput.hasClass('guiPreferencesInput')) {
					$governmentIdCodeInput.removeClass('guiPreferencesInput')
				}
				break;
			case 0:
				$ErrorGeneralDonationCode.show();
				if (!$donationCodeSearchInput.hasClass('guiPreferencesInputError')) {
					$donationCodeSearchInput.addClass('guiPreferencesInputError')
				}
				if ($donationCodeSearchInput.hasClass('guiPreferencesInput')) {
					$donationCodeSearchInput.removeClass('guiPreferencesInput')
				}
				break;
			default:
				break;
		} 
	}

	function resetNonValidationMessages(codeType) {

		switch (codeType) {
			case 1:
				$ErrorGeneralCarrierCode.hide();
				$SuccessCarrierCode.hide();
				if ($carrierCodeInput.hasClass('guiPreferencesInputError')) {
					$carrierCodeInput.removeClass('guiPreferencesInputError')
				}
				if (!$carrierCodeInput.hasClass('guiPreferencesInput')) {
					$carrierCodeInput.addClass('guiPreferencesInput')
				}
				break;
			case 2:
				$ErrorGeneralGovernmentId.hide();
				$SuccessGovernmentId.hide();
				if ($governmentIdCodeInput.hasClass('guiPreferencesInputError')) {
					$governmentIdCodeInput.removeClass('guiPreferencesInputError')
				}
				if (!$governmentIdCodeInput.hasClass('guiPreferencesInput')) {
					$governmentIdCodeInput.addClass('guiPreferencesInput')
				}
				break;
			case 0:
				$ErrorGeneralDonationCode.hide();
				$SuccessDonationCode.hide();
				if ($donationCodeSearchInput.hasClass('guiPreferencesInputError')) {
					$donationCodeSearchInput.removeClass('guiPreferencesInputError')
				}
				if (!$donationCodeSearchInput.hasClass('guiPreferencesInput')) {
					$donationCodeSearchInput.addClass('guiPreferencesInput')
				}
				break;
			default:
				break;
		}

	}

	function resetSuccessMessages(codeType) {

		switch (codeType) {
			case 1:
				$SuccessCarrierCode.hide();
				break;
			case 2:
				$SuccessGovernmentId.hide();
				break;
			case 0:
				$SuccessDonationCode.hide();
				break;
			default:
				break;
		}

	}

	function resetValidationMessages(codeType) {

		switch (codeType) {
			case 1:
				$ErrorValidationCarrierCode.hide();
				if ($carrierCodeInput.hasClass('guiPreferencesInputError')) {
					$carrierCodeInput.removeClass('guiPreferencesInputError')
				}
				if (!$carrierCodeInput.hasClass('guiPreferencesInput')) {
					$carrierCodeInput.addClass('guiPreferencesInput')
				}
				break;
			case 2:
				$ErrorValidationGovernmentId.hide();
				if ($governmentIdCodeInput.hasClass('guiPreferencesInputError')) {
					$governmentIdCodeInput.removeClass('guiPreferencesInputError')
				}
				if (!$governmentIdCodeInput.hasClass('guiPreferencesInput')) {
					$governmentIdCodeInput.addClass('guiPreferencesInput')
				}
				break;
			case 0:
				$ErrorValidationDonationCode.hide();
				if ($donationCodeSearchInput.hasClass('guiPreferencesInputError')) {
					$donationCodeSearchInput.removeClass('guiPreferencesInputError')
				}
				if (!$donationCodeSearchInput.hasClass('guiPreferencesInput')) {
					$donationCodeSearchInput.addClass('guiPreferencesInput')
				}
				break;
			default:
				break;
		}
	}

</script>
